<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World Suave</title>
    <script src="/jquery.min.js"></script>
    <script src="/browser.js"></script>
    <script>
      function get_cookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
      }

      var auth_state = function () {
        var $auth_state = $('#auth_state');
        if (typeof get_cookie('auth') === 'undefined') {
          $auth_state.text('no auth');
          $("#login").show();
        } else {
          $auth_state.text('auth');
          $("#login").hide();
        }
      };

      var api_state = function() {
        var $api_state = $('#api_state');
        var token = localStorage.api_token
        if (typeof token === 'undefined') {
          $api_state.text('no api token');
        } else {
          $api_state.text('api token');
        }
      };

      var submit_form = function(evt){
        evt.preventDefault();
        var usr = $('#username').val();
        var pw = $('#password').val();

        var url = 'http://localhost:8083/api/secret'

        var credentials = {
          id: 'dh37fgj492je',
          key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
          algorithm: 'sha256',
          user: usr
        };

        var requestOptions = {
          url: url,
          method: 'POST',
          host: 'localhost',
          port: 8083
          headers: {}
        };

        var credentialsFunc = function (id, callback) {
          return callback(null, credentials);
        };

        $.post("/api/secret", function(data,status){
          var header = hawk.client.header(url, req.method, { credentials: credentials });

          $.ajax({
            dataType: "json",
            headers: { authorization: header.field },
            url: url,
            success: function (error, response, body) {
              var isValid = hawk.client.authenticate(body, credentials, header.artifacts, {
                payload: body.responseText,
                required: true
                });

              if (isValid) {
                $("#response").html(body.responseText);
              }
              else {
                $("#response").html("not valid");
              }
           }
          });
        });
      }

      $(auth_state);
      $(api_state);
      $(function () { $("#login_form").submit(submit_form); });
    </script>
  </head>
  <body>
  <header>
    <div id="auth_state">
      <noscript>Enable JS to see your authenticated state</noscript>
    </div>
    <div id="api_state">
      <noscript>Enable JS to see your API token state</noscript>
    </div>
  </header>
  <span id="response"/>
  <div id="contents">
    This is actually a static html file served from Suave.
  </div>
  <fieldset id="login">
    <form id="login_form" action="/login">
      <p>
        <label for="username">
          Username:
          <input id="username" type="text" name="username"/>
        </label>
      </p>
      <p>
        <label for="password">
          Password:
          <input id="password" type="password" name="password"/>
        </label>
      </p>
      <p>
        <input type="submit" id="login_button" value="Log In!" />
      </p>
    </form>
  </fieldset>
  </body>
</html>
